# -*- coding: utf-8 -*-

import httplib
from tornado import web, testing

from pyDoubles.framework import *
from hamcrest import *

from viper import handlers, commands

URL = r'/'

class TestDistutilsHandler(testing.AsyncHTTPTestCase):
    def test_parses_body_using_bare_linefeeds_with_submit_action(self):
        self.expects_command_creation_for('submit')

        response = self.fetch(URL, method='POST',
            body=self.distutils_submit_body(),
            headers=self.distutils_headers()
        )

        assert_that(response.code, is_(httplib.OK))
        self.assert_that_command_was_called()

    def test_parses_body_using_bare_linefeeds_with_file_upload_action(self):
        self.expects_command_creation_for('file_upload')

        response = self.fetch(URL, method='POST',
            body=self.distutils_file_upload_body(),
            headers=self.distutils_headers()
        )

        assert_that(response.code, is_(httplib.OK))
        self.assert_that_command_was_called()

    def expects_command_creation_for(self, action):
        self.fake_command = spy(commands.Command())

        when(self.commands.command_for).with_args(action).then_return(self.fake_command)

    def assert_that_command_was_called(self):
        assert_that_method(self.commands.command_for).was_called()
        assert_that_method(self.fake_command.execute).was_called()

    def get_app(self):
        self.commands = spy(commands.CommandFactory())
        return web.Application([
            (URL, handlers.DistutilsHandler, dict(distutils_commands=self.commands))
        ])

    def distutils_headers(self):
        return {'Content-Type': 'multipart/form-data; boundary=--------------GHSKFJDLGDS7543FJKLFHRE75642756743254; charset=utf-8'}

    def distutils_submit_body(self):
        return '\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="license"\n\nMIT/X11\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="name"\n\nviper\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="metadata_version"\n\n1.0\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="author"\n\nN\xc3\xa9stor Salceda\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="home_page"\n\nUNKNOWN\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name=":action"\n\nsubmit\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="download_url"\n\nUNKNOWN\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="summary"\n\nUNKNOWN\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="author_email"\n\nnestor.salceda@gmail.com\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="version"\n\n0.1dev\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="platform"\n\nUNKNOWN\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="keywords"\n\n\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="description"\n\nUNKNOWN\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254--\n'

    def distutils_file_upload_body(self):
        return '\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="comment"\n\n\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="metadata_version"\n\n1.0\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="filetype"\n\nsdist\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="keywords"\n\n\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="protcol_version"\n\n1\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="author"\n\nN\xc3\xa9stor Salceda\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="home_page"\n\nUNKNOWN\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="download_url"\n\nUNKNOWN\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="content";filename="viper-0.1dev.tar.gz"\n\n\x1f\x8b\x08\x08k\x9b\x18N\x02\x03viper-0.1dev.tar\x00\xed[\xfd\x8e\xdb6\x12\xdf\xbf\xf5\x14D\x82\x83\xe4\x85-[\xfel]\xe8zA\x9a4Ao7A\xb3\xbd\x16p\x0c\x81\x96h\x9b\xb1,\xaa$\xe5\xacs\xb8\x07\xba\xe7\xb8\x17\xbb!\xf5\xe9\x8f\xddm\x90]\xef]\xa3\xf9G\xd6\x903Cr\xf8\xa3fHzCc\xc2[\x1d\xdb\t\xc8\xa6}\xf60\xd4\x01\x1a\r\x06\xea\xe9\x8c\x06\xdd\xec\xe9h~Fg\x8e3\xec\x0c\x1dg0\x18\xf4\xce:Nw\xe8t\xcf\xd0\xe0\xec\x04\x94\x08\x899Bg\x11\x11\x92\xf1\x9b\xeb\xddU\xfe\x7fJ\x9b\xaa\xff\xf5\x8bM\x16\x8b\x16\x8d\xe6\xac\xfdx\xfe\x1f\xf4{N\xed\xff\xc7\xf6\xff\xbb7\xbf\xfc\xfc\xfc\xc5;[^\xcb/\xf6\xff\xb0\xdf\xbf\xd1\xff\xfdn\x7f\xcf\xff\xa3\x9e38C\x9d\xda\xff\x0fN\x82\xc8$\xb6\xfd\xf9\xc2H\x7f\xc5[C\xcf\x82\xb6\xe7\xd1\x88J\xcf+9>[\xafq\x14\x88\x92\xb3\x84\xd7\x90\xf0\x92S\xce\x9d\xb7?\xfd\xd8z}\xf9\xf2\x8dq\xf3\x9c\xda/\nHL\xa2\x80D\xfe\xd6\x0bi\xb4\x12\xc7\xea\x90H\xf2\xad\x173\x1a\xc9\xa3\xe5\x11\x93\xadO4n\t<\'\xfbe\x9c\xfc\x9ePN\x8e\xcaI\x16{!\xd9\x90\xf0\x8b\'\xfb\x9f\x08\xff\xc7\x1c\xf2\x10\xf8\x87\xd7]\xfcw\x9d\xfehT\xe3\xff\x14d\x9c\xd5\xf45\xd3m\xf8\xaf.\xa6\x0f\xf9\xfd/\xf0\xdf\xe9uz\xc3\x91\xfa\xfe\x0f\x07\xc3\x1a\xff5\xfekzL\xfc\xe71\xdc}\xe4\x7f\xb7\xe1_\x05\xfb\xbb\xf1\xffp\xd0\xad\xe3\xff\x93\xd0\x05\x918\xc0\x12\xb7\xfe\x01q<e\xd1\x189v\xc7\xb8\xc4k2Fz:\x18EA:I\x8cw\t\xa4\x01|;F\xbf\\\xfet\xf9\xe6\xd7K\xe3\x15[\x93V\x8c\x17\xa4d=K\xe4\x92\xf11\xba\xfc\xcf\xbf\xd5\xa8\xa1w8\xf4I\x803~\x8b\xac1\r\xc7(\x1dR[\xa4\x85\x7f[(\xae\rY\x86\xf1w\xea\x93H\x80\xbe\x8b\xd7W\xed\xdf\x1c\xc7\xf8\x81\x08\x9f\xd3X\xeav\xe4F\xde\x86X\xce\x19_\x97\x9c\x1a\xce\xf7\x8a\xffj\xc2\xf4\xa0\xdf\xff\xc1\x1e\xfe\xbbjM\xa8\xf1\x7f\n\x82>E8`\xc6\x9aE\x0bF\xa2\x05\x8d\x88\x11o\x03\x96\xccB"\x8c\x88\t\xf5\xba\xc4k\x1f\xe6\x81\xac\xe1\xf2U\xe1\x7f\x7f\xb3\xe5\xc1\xf0\xdf?\xc0\xff\xa8[\xc7\xff\xa7\x89\xff\x91\xa6\xa7\xa8u\xdeB/\x94\xc3Q\xea\xf0\xb1\xe2d\xa55L\xbeJ\xfc\xdf\xd7\xa6\xe8\xdd\xf9\xffp\x1f\xff\xce\xa0\xde\xff;\x9d\xff\xeb\xc0\xb9\xc6\x7f\x81\xff\xfb\xbf\x05\xf0\xf9\xe7\xbf\xbdQoT\x9f\xff>\x92\xff+\xa7z\xf7\xe7\xff[\xd6\xff~\xaf\x12\xff9\xf0-\xe88\xf0\xab\xce\xffNBi\xe0\xe7\xb3\x80F\x8b1J\xe4\xbc\xf5\x8d\x0e\xfc\x8c9gk\x94e\x87\x88\xaec\xc6%\xfaHf\x86\xe1\x87X\x08t\x81i\xf4*\x9d(\x16\xb0\xed\x9f\xc9\xef\t\x8cP\xc6j\x8cu\xe4\x18\x909Z\x10i\t\x12\xce3\x96"\xf5jsu\xb4\xc8-s\r\x8a\xec\xa5\\\x87f#\xd7\xfd\x03\x152\x914\x14\xb7\x1a(,\xa8sj\x8aC\xfa\x89hCM\x14\xe4\xf2^~d\xbdo\xfc\xb0\x06r\x8f\x88\x956b&\x0e\xba\x81\xf9"YC\x8e\xa4d\xb5V/\xc6\\\x10\x0f\xf8\xc2S\xc3\xe7\xcdX\xb0\xb5\x1a\xa5\x80\xaf6\xb0\xa0v!i\xc7,\xb6\xccqZ\xa0\x06\xe0\x8eV\xda\xd9\x0fo\xce\xb8\x95J5lrM\xfcD\x12\xeb\xfc\xbc\xd0\x9biz\x8a^\xbe\xfe\xed\xe2\xc5\x18-\xa5\x8c\xc7\xed\xf6\x82\xb3$\x16\xf6\x82\xb1EH\x94\xae\x94\xd3\x8e\xb7r\xc9\xa2V\xe6\xed\xf6\x8c\xb3\x8f\xd0\x0f\xb9\xe4\x04\x07\xed\xec\x11t\x06=\x87\xf4z\x8e\xef|\xf3\xad?\x18~\x1f\x87\xd4u23J\xbfP\x06\xa8\\&3\xady\xb6\xfa\xc0\x003\xed\x0bp\x8f\x80\xb4\xe2\xcd\xfc-\xf6Wx\x01\xacY\xc8f\xed5\x16\x12\x16\x9b#\xc5\xf9\xfa\xd3~\xa7n$\xbc\xdd\xaa\xdb\x05\xdaLf\xccO8L\x1eY\xfa\x0bm\xd2-J\x81\x02\x18E\x89\x12AP\xcc\x19\xace(\xa4\x11A`gM#\x0c\xdd\x13\x08\x06\x0e\xbd\xba\xbaz\x8b\x96\xd0)\x10kfJ\x05\x83\xd9\x8d|\xac\xe4C\x82#\x04\x8e\xbaJ\xc7\xc3\x14(\xa2>\t\xb7-\xf0V\x12bI\x82|\n\xeb)i\x17\xc3\xdeD\xd0\xf4\\a\xb5\xc6\x9c\x86D\xd8\xe8W\x82\x96x\x03\rbH\x81J"\xf0e\x82\xc3pk\x17\x13\xed\xf8\x1c\xda\x9by\xbe\x9cS\x12\x06\xc5\xc4\xcb\xcdd}\x9a\x98\xcfY$\xa1A\xad\xabmL\xcc\xa9-\xc0W\xd22\xbf\xab\xce\xb0\x19K\xa2\x00C\xba\xe7\xa2\x89\xd6\x96\xd7r\xcd\xc6\xc4\x99\xea\x81\xd2|\xc0Wi\x90\xce\x91\x99K\xba\xa6*\xd2\x05\xd3IgZ\xaa\xf6\x97I\xb4:h\x9c\xeaHf#\xd7Pi\x8e\xea0H\xfc\xf3_\x05G5\x80j\xe3Z]\xd9{E\xaa\x1djP#\xbc&\xba\x19t\xb7\\\xd12\x00\xf7"U\x0b\xf0\xa3\xc7CY\xa0y?\xdfG\xef#\xb3\x89\x9c\xc61A/\xa0\xbe\xd4k\x82/\xad\x89\xb5\xac\x0cNC\xb7l\xa9\x8c*\x0b\x95\xc1\xd5\xadJGe9=T{\xd0\xe6\xdc\x8e\xbd"[a5\x0e{\xa0\x87A\xb5_\x89@kr\x81I\xa9gzTH\x8df\xb5\x12\xc8\x16z\xee\x10\xc8\x86\xaa\x94\xc9\xc7\xee\xa8\x9c*\xa4QB\x8cC\xef0\xben\xa9\x93\x85\x9b\xdc\x03&gTV=\xf2\x9d\x9ey\xc6A\xcd\x98\xebn4\xd5\x8f\r\x0e\xd3\x05\x14dw<\xd98\x94[A\xcdLvwr\x1fs\xcd\xcaV\x81\x80\x14\x1fa\t\xb3\xcc\'\xe0M\xc02p\xe13U\xf2\x8e\xbbH\xd9YM\x9cq\xeb\x88\xe6M\xda\x06h\xb6\xcda\x9d\xa3\xb1jn\xabu\xac\xb9\xaa\x11\xc8u\x91\xa9\xbf\x82\x14\x80\xc5\x85y\xdc\xa2\xae\n\xc3\xaa\xdcv\xbcF\xba\x08\xc9%\xe1zUC3\x82\xfe\xea 6W,A\xec\x1be\xf4DXMm\x1c\xab\xbb?\xd6\xa6q\xb4&\t\x05\xb9\xc5\xee\x9cB_Q\xd9\rXZMh\x07\x0eT\x94q\xa7m\xb5"m\x0eG\xf2f\x9b\xa5\xdc\xa6\x1cU\x0e\x1f\x0f\x9e\x8eP\x9d\xde~V\xfc_\xb9\xe7w\x92\xf8\xbf\xd3\xebV\xf2\xbf\xfe(\x8d\xff;u\xfc\xff\xa8\xf1\x7f\x1a\x8a?O\xe7\xc2K\x885\x19\xdfZl\xf6\x81\xf8\xb2\x12\xddW\xe3\xd14\xf8\xce\xa2\xd2\xf1>\x103MVcO\xf5\xa1\xce<\x9eM\xf5\x9d\x9f\xaf>*\x10W5b\n\x11\xde%\x93\xaf\xd7qHT\xe4E\x82\x17\x9cC\x13\x1a5\xd4\xbf\x1c\xff\x95\x9b\xbf\xa7\xc1\xff`0\xca\xf1\xdf\x19\x8e\xba\n\xff\x9dA\xbf\xc6\xff\xa3\xe2?K\xf9\x99\xb8q\' \xfb\x99\xa7k\xf9{\x99<C\x0c\x11R\x1fgI\xafJ\xe2\x9f\x95\x1cK\xc3yR\x80\xda\xe2f\x1b\xc2\xf1b\xf3\xa9\xb2\xc1\xd0h\xee\xd4*\xf2\xbej\xf5\xfd=\x83f\x1a\xba\x1f\xa6\xd0n\xf1y\xdb[\xdb\x1a\x8d\xcc\xce\xb4\x99-E\xb3d\xe1^\xf1\x84\xa4\xef\x92\xc0j\x03\xc9\x1fdhr\xe92\xf8<\xc2\xd3\xfe\xc0hd\xe5/\x01\xe5*\xd8\xb4<OG\xce^\xa3\x89\xcc\\L@\xc8\xf7?\xb8<\xed\xe0\xff\xbe.|}\xee\xf7\xff\xe0\xfeWo\xd4\xa9\xcf\x7fOB\xf5\xfd\xaf\xfa\xfb_\xe0\xbf\xf83\xd0i\xf1\xdf\x19\xed\x9d\xff:\xfd~\xaf\xc6\xffIhB\x16\x0bO\x9d\xf6O\r\x89\x17\xde,\xa1a\xa0\xf6\xbd\x00\xe8\xea\x1d\x96\x06\xb5\xf1\xd4\xd1/b\x13y\x9cl\xa8H?\xe8\x1d\xa3\x06\xdc\x9f\x11\xff\xf7\x15\xf6\xffQ\xfc;\xbda\x8e\xffN\xbf\xdb\x1b(\xfc\xf7\xea\xfb\xdf\xa7!\x1d\xdck\xbfK\xc6B\x91\xc7\xf7\x9a\xa36\xcf!\xb7\x8f\xb3\x83\x99<\xc0\x17[\xd1Ty\x81\x91\x1d\xbb\xc0R`\xc2\x042\x8d\xf4/\xa4\x96\n\x81]SO,3\x8f\xdc\xb3\xaan\xf6\xcc\xd9A\xf9]w\x9f<\xc9\xb9!\x8b`\xe5\xd9)z\xf2\xdexRV\xa8l\x90\xba\x93i\x13=E?\x12h\x97\xe4\x90\xc4\x08\xa4\xbb\x94\x9dx\xc5\xdb\x98\xda\xe9\xf1\x96\xcd\xf8B\xbf\x7f\xff\x97\xde\xb3t\x97\xc2\r!=\xf0*\xda2\xfd+\xb2\xfd\xc88\xe4\nf\xd1\x01\xac#\x17\xd7\xbc|\x7f\xed\xf7\xde_\xe3o\xabq\xcd^-O\xc77\xaeyS|STOxX1\x11\xa6Q\x8fkfQOQ\x90;\xc0\xddq\x87E\xae\xfd0\t\x88;1\xc9\'O\x0f=$D&\xb9\xc6jWD%G\x90{\x08)\xcci\x91?\xd1HK\xe4*\xd4\xea\x8e+\x19\x0eB\x9fh\xec\xa9\x7f{\xb9/q(H)\x06\x18\tC/\xbf\x0f\xeeN*\xdb\xb0f\x96\x19\x9a\xcd*\xb3r\x9dx\xb7\xa0\xb8[\xbc\xcbV\x17\x8d\xf7+\xe6\xb7\x8e\xcd\x8c=\xcd\xcb\xab\xf7R\xd5\xdc\xf8Cw\x18+\xd3\xa7\xde%\xaa\xa9\xa6\x9aj\xaa\xa9\xa6\x9aj\xaa\xa9\xa6\x9a\xbeF\xfa/\xaf\xeb\x970\x00P\x00\x00\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="platform"\n\nUNKNOWN\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="version"\n\n0.1dev\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="description"\n\nUNKNOWN\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="md5_digest"\n\n4ab6e9469870b9de86f29b02913895dd\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name=":action"\n\nfile_upload\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="name"\n\nviper\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="license"\n\nMIT/X11\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="pyversion"\n\n\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="summary"\n\nUNKNOWN\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254\nContent-Disposition: form-data; name="author_email"\n\nnestor.salceda@gmail.com\n----------------GHSKFJDLGDS7543FJKLFHRE75642756743254--\n'
